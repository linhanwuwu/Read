<!-- ############################################################ -->
<!-- ##### 现代化小说阅读器（支持GitHub自动加载小说） ##### -->
<!-- ############################################################ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轻小说阅读器</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... CSS样式保持不变 ... */
        /* 为了节省空间，这里省略了重复的CSS代码 */
        /* 请保留之前的所有CSS样式 */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>轻小说阅读器</h1>
            <p class="subtitle">优雅的在线TXT小说阅读体验</p>
        </header>

        <!-- 小说选择界面 -->
        <section class="book-selection" id="bookSelection">
            <div class="upload-section">
                <input type="file" id="fileInput" accept=".txt">
                <label for="fileInput" class="upload-label">选择TXT文件</label>
                <p class="upload-hint">请选择一个TXT格式的小说文件开始阅读</p>
                <p class="upload-hint">或者从下方列表中选择已有的小说</p>
            </div>
            
            <div class="loading-books" id="loadingBooks">
                <p>正在加载小说列表...</p>
            </div>
            
            <div class="book-list" id="bookList">
                <!-- 小说列表将通过JavaScript动态生成 -->
            </div>
        </section>

        <section class="processing-info" id="processingInfo" style="display: none;">
            <p>正在处理文件，请稍候...</p>
        </section>

        <section class="reader-section" id="readerSection">
            <button class="back-to-books" id="backToBooks">← 返回小说列表</button>
            <div class="chapter-title" id="chapterTitle"></div>
            <div class="content" id="content"></div>
            <div class="controls">
                <div class="control-group nav-buttons">
                    <button id="prevPage">上一章</button>
                    <button id="nextPage">下一章</button>
                    <div class="page-info" id="pageInfo">第 1 章 / 共 1 章</div>
                </div>
                <div class="control-group setting-buttons">
                    <select id="fontSize">
                        <option value="small">小号字体</option>
                        <option value="medium" selected>中号字体</option>
                        <option value="large">大号字体</option>
                    </select>
                    <button id="toggleMode">夜间模式</button>
                    <input type="number" id="chapterInput" placeholder="章节" min="1">
                    <button id="goToChapter">跳转</button>
                    <button id="chapterListBtn">章节列表</button>
                </div>
            </div>
        </section>
    </div>

    <!-- 章节列表弹窗 -->
    <div class="chapter-list-modal" id="chapterListModal">
        <div class="chapter-list-content">
            <div class="chapter-list-header">
                <h3>章节列表</h3>
                <button class="close-btn" id="closeChapterList">&times;</button>
            </div>
            <div class="chapter-list-items" id="chapterListItems">
                <!-- 章节列表将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 音乐播放器悬浮窗 -->
    <div class="music-player-container">
        <div class="music-player-mini" id="miniPlayer">
            <div class="play-icon">♪</div>
        </div>
        
        <div class="music-player-full" id="fullPlayer">
            <button class="close-btn-player" id="closeBtnPlayer">×</button>
            
            <div class="album-cover-container">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiMzMzMzMzMiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzIyMjIyMiIvPjxwYXRoIGQ9Ik01MCwxMEw2MCw0MEw5MCw0MEw2NSw2MEw3NSw5MEw1MCw3MEwyNSw5MEwzNSw2MEwxMCw0MEw0MCw0MEw1MCwxMFoiIGZpbGw9IiNmZjAwMDAiLz48L3N2Zz4=" 
                     alt="Album Cover" class="album-cover" id="albumCover">
            </div>
            
            <div class="song-info">
                <div class="song-title" id="songTitle">未选择歌曲</div>
                <div class="song-artist" id="songArtist">请添加音乐文件</div>
            </div>
            
            <div class="loading-indicator" id="loadingIndicator" style="display: none;">
                正在加载音乐和歌词...
            </div>
            
            <div class="lyrics-container" id="lyricsContainer">
                <div class="lyrics" id="lyrics">享受音乐时光</div>
            </div>
            
            <div class="toggle-lyrics">
                <label>
                    <input type="checkbox" id="lyricsToggle" checked> 显示歌词
                </label>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="volume-control">
                <span>🔊</span>
                <input type="range" min="0" max="1" step="0.01" value="1" class="volume-slider" id="volumeSlider">
            </div>
            
            <div class="controls">
                <button class="control-btn" id="prevBtn">⏮</button>
                <button class="control-btn play-btn" id="playBtn">▶</button>
                <button class="control-btn" id="nextBtn">⏭</button>
            </div>
            
            <div class="file-input-container">
                <input type="file" id="fileInputMusic" accept=".mp3,.flac,audio/*" multiple>
                <label for="fileInputMusic" class="file-input-label">添加音乐</label>
            </div>
            
            <div class="playlist-container" id="playlistContainer">
                <div class="playlist-item" id="defaultPlaylistItem">暂无播放列表</div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        // ############################################################
        // ##### 现代化小说阅读器核心功能实现 #####
        // ############################################################
        
        class ModernNovelReader {
            constructor() {
                this.chapters = []; // 存储章节信息
                this.currentChapterIndex = 0;
                this.fontSize = 'medium';
                this.isNightMode = false;
                this.currentBook = null; // 当前阅读的小说
                
                this.initElements();
                this.bindEvents();
                this.loadBookList(); // 加载小说列表
            }
            
            initElements() {
                this.bookSelection = document.getElementById('bookSelection');
                this.readerSection = document.getElementById('readerSection');
                this.processingInfo = document.getElementById('processingInfo');
                this.contentElement = document.getElementById('content');
                this.chapterTitleElement = document.getElementById('chapterTitle');
                this.prevPageBtn = document.getElementById('prevPage');
                this.nextPageBtn = document.getElementById('nextPage');
                this.pageInfo = document.getElementById('pageInfo');
                this.fontSizeSelect = document.getElementById('fontSize');
                this.toggleModeBtn = document.getElementById('toggleMode');
                this.chapterInput = document.getElementById('chapterInput');
                this.goToChapterBtn = document.getElementById('goToChapter');
                this.chapterListBtn = document.getElementById('chapterListBtn');
                this.chapterListModal = document.getElementById('chapterListModal');
                this.chapterListItems = document.getElementById('chapterListItems');
                this.closeChapterListBtn = document.getElementById('closeChapterList');
                this.fileInput = document.getElementById('fileInput');
                this.bookList = document.getElementById('bookList');
                this.loadingBooks = document.getElementById('loadingBooks');
                this.backToBooks = document.getElementById('backToBooks');
            }
            
            bindEvents() {
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.prevPageBtn.addEventListener('click', () => this.prevChapter());
                this.nextPageBtn.addEventListener('click', () => this.nextChapter());
                this.fontSizeSelect.addEventListener('change', (e) => this.changeFontSize(e.target.value));
                this.toggleModeBtn.addEventListener('click', () => this.toggleNightMode());
                this.goToChapterBtn.addEventListener('click', () => this.goToChapter());
                this.chapterListBtn.addEventListener('click', () => this.showChapterList());
                this.closeChapterListBtn.addEventListener('click', () => this.hideChapterList());
                this.backToBooks.addEventListener('click', () => this.showBookSelection());
                
                // 点击模态框外部关闭
                this.chapterListModal.addEventListener('click', (e) => {
                    if (e.target === this.chapterListModal) {
                        this.hideChapterList();
                    }
                });
                
                // 回车键跳转章节
                this.chapterInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        this.goToChapter();
                    }
                });
            }
            
            // 加载小说列表 - 使用GitHub API
            async loadBookList() {
                try {
                    // 获取当前页面的URL信息来确定仓库信息
                    const path = window.location.pathname;
                    const repoPath = path.split('/')[1]; // 获取仓库名
                    const username = window.location.hostname.split('.')[0]; // 获取用户名
                    
                    // 如果是在本地运行，使用备用方法
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        this.loadBookListFallback();
                        return;
                    }
                    
                    // 使用GitHub API获取Book文件夹中的文件
                    const apiUrl = `https://api.github.com/repos/${username}/${repoPath}/contents/Book`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error('无法访问GitHub API');
                    }
                    
                    const files = await response.json();
                    const books = [];
                    
                    // 筛选出txt文件
                    files.forEach(file => {
                        if (file.name.endsWith('.txt')) {
                            books.push({
                                name: file.name,
                                url: file.download_url,
                                title: file.name.replace('.txt', ''),
                                author: '未知作者'
                            });
                        }
                    });
                    
                    this.displayBookList(books);
                } catch (error) {
                    console.error('加载小说列表时出错:', error);
                    // 如果API访问失败，尝试直接访问文件
                    this.loadBookListFallback();
                }
            }
            
            // 备用加载方法 - 直接尝试访问文件
            async loadBookListFallback() {
                try {
                    // 尝试获取常见的小说文件
                    const commonBooks = [
                        '示例小说1.txt',
                        '示例小说2.txt',
                        '小说1.txt',
                        '小说2.txt'
                    ];
                    
                    const books = [];
                    
                    for (const bookName of commonBooks) {
                        try {
                            const response = await fetch(`Book/${bookName}`);
                            if (response.ok) {
                                books.push({
                                    name: bookName,
                                    url: `Book/${bookName}`,
                                    title: bookName.replace('.txt', ''),
                                    author: '未知作者'
                                });
                            }
                        } catch (err) {
                            // 文件不存在，跳过
                        }
                    }
                    
                    this.displayBookList(books);
                } catch (error) {
                    console.error('备用加载方法失败:', error);
                    this.loadingBooks.innerHTML = '<p>加载小说列表失败，请手动选择文件</p>';
                }
            }
            
            // 显示小说列表
            displayBookList(books) {
                this.loadingBooks.style.display = 'none';
                
                if (books.length === 0) {
                    this.bookList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666666;">暂无小说，请手动上传或检查Book文件夹</p>';
                    return;
                }
                
                this.bookList.innerHTML = '';
                
                books.forEach(book => {
                    const bookItem = document.createElement('div');
                    bookItem.className = 'book-item';
                    bookItem.innerHTML = `
                        <div class="book-title">${book.title}</div>
                        <div class="book-info">作者: ${book.author || '未知'}</div>
                        <div class="book-info">${book.name}</div>
                    `;
                    
                    bookItem.addEventListener('click', () => {
                        this.loadBookFromFile(book.url, book.title);
                    });
                    
                    this.bookList.appendChild(bookItem);
                });
            }
            
            // 从文件加载小说
            async loadBookFromFile(url, title) {
                try {
                    this.processingInfo.style.display = 'block';
                    this.bookSelection.style.display = 'none';
                    
                    const response = await fetch(url);
                    const content = await response.text();
                    
                    this.currentBook = { title, url };
                    this.parseChapters(content);
                    
                    if (this.chapters.length > 0) {
                        this.showChapter(0);
                        this.readerSection.style.display = 'block';
                    } else {
                        // 如果没有检测到章节，则按固定长度分页
                        this.createChaptersFromContent(content);
                        this.showChapter(0);
                        this.readerSection.style.display = 'block';
                    }
                    
                    this.processingInfo.style.display = 'none';
                } catch (error) {
                    console.error('加载小说时出错:', error);
                    this.processingInfo.style.display = 'none';
                    this.bookSelection.style.display = 'block';
                    alert('加载小说失败，请检查文件格式');
                }
            }
            
            // 处理手动选择的文件
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.processingInfo.style.display = 'block';
                this.bookSelection.style.display = 'none';
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    this.currentBook = { title: file.name, url: null };
                    this.parseChapters(content);
                    if (this.chapters.length > 0) {
                        this.showChapter(0);
                        this.readerSection.style.display = 'block';
                    } else {
                        // 如果没有检测到章节，则按固定长度分页
                        this.createChaptersFromContent(content);
                        this.showChapter(0);
                        this.readerSection.style.display = 'block';
                    }
                    this.processingInfo.style.display = 'none';
                };
                reader.readAsText(file, 'UTF-8');
            }
            
            // 智能解析章节
            parseChapters(content) {
                // 清空之前的章节
                this.chapters = [];
                
                // 定义章节标题的正则表达式
                const chapterPatterns = [
                    /第\s*([0-9一二三四五六七八九十百千万]+)\s*[章节篇回集卷]/g,
                    /Chapter\s*([0-9]+)/gi,
                    /[章节]\s*([0-9]+)/g
                ];
                
                let matches = [];
                let match;
                
                // 查找所有章节标题
                for (const pattern of chapterPatterns) {
                    while ((match = pattern.exec(content)) !== null) {
                        matches.push({
                            index: match.index,
                            title: match[0],
                            number: this.parseChapterNumber(match[1])
                        });
                    }
                }
                
                // 按位置排序
                matches.sort((a, b) => a.index - b.index);
                
                // 如果没有找到章节标题，尝试按固定长度分页
                if (matches.length === 0) {
                    return;
                }
                
                // 创建章节内容
                for (let i = 0; i < matches.length; i++) {
                    const start = matches[i].index;
                    const end = i < matches.length - 1 ? matches[i + 1].index : content.length;
                    const chapterContent = content.substring(start, end).trim();
                    
                    this.chapters.push({
                        title: matches[i].title,
                        number: matches[i].number,
                        content: this.formatContent(chapterContent)
                    });
                }
                
                // 按章节号排序
                this.chapters.sort((a, b) => a.number - b.number);
            }
            
            // 解析章节号（支持中文数字）
            parseChapterNumber(str) {
                // 尝试直接转换为数字
                const num = parseInt(str, 10);
                if (!isNaN(num)) {
                    return num;
                }
                
                // 处理中文数字
                const chineseNumMap = {
                    '一': 1, '二': 2, '三': 3, '四': 4, '五': 5,
                    '六': 6, '七': 7, '八': 8, '九': 9, '十': 10,
                    '百': 100, '千': 1000, '万': 10000
                };
                
                // 简单处理常见的中文数字
                if (chineseNumMap[str]) {
                    return chineseNumMap[str];
                }
                
                // 如果无法解析，返回一个大数，使其排在最后
                return Infinity;
            }
            
            // 当无法识别章节时，按固定长度创建章节
            createChaptersFromContent(content) {
                this.chapters = [];
                const pageSize = 5000; // 每章字符数
                
                for (let i = 0; i < content.length; i += pageSize) {
                    const chapterContent = content.substring(i, i + pageSize);
                    this.chapters.push({
                        title: `第 ${Math.floor(i/pageSize) + 1} 章`,
                        number: Math.floor(i/pageSize) + 1,
                        content: this.formatContent(chapterContent)
                    });
                }
            }
            
            // 格式化内容，仿照番茄小说格式
            formatContent(content) {
                // 移除内容开头的章节标题（如果存在）
                const titlePattern = /^(第\s*[0-9一二三四五六七八九十百千万]+\s*[章节篇回集卷].*?)(?:\n|$)/;
                content = content.replace(titlePattern, '').trim();
                
                // 按段落分割（以两个或多个换行符为分隔）
                let paragraphs = content.split(/\n\s*\n/);
                
                // 过滤掉空段落
                paragraphs = paragraphs.filter(p => p.trim() !== '');
                
                // 对每个段落进行处理
                return paragraphs.map(paragraph => {
                    // 移除段落内的多余空格和换行
                    let cleanParagraph = paragraph.replace(/\s+/g, ' ').trim();
                    return cleanParagraph;
                }).join('\n\n'); // 段落之间用两个换行符分隔
            }
            
            // 显示指定章节
            showChapter(index) {
                if (index < 0 || index >= this.chapters.length) return;
                
                this.currentChapterIndex = index;
                const chapter = this.chapters[index];
                
                // 显示章节标题和内容
                this.chapterTitleElement.textContent = chapter.title;
                this.contentElement.textContent = chapter.content;
                this.contentElement.className = `content ${this.fontSize}`;
                
                // 更新页码信息
                this.pageInfo.textContent = `第 ${index + 1} 章 / 共 ${this.chapters.length} 章`;
                
                // 更新按钮状态
                this.prevPageBtn.disabled = (index === 0);
                this.nextPageBtn.disabled = (index === this.chapters.length - 1);
                
                // 更新章节输入框
                this.chapterInput.value = index + 1;
            }
            
            // 上一章
            prevChapter() {
                if (this.currentChapterIndex > 0) {
                    this.showChapter(this.currentChapterIndex - 1);
                }
            }
            
            // 下一章
            nextChapter() {
                if (this.currentChapterIndex < this.chapters.length - 1) {
                    this.showChapter(this.currentChapterIndex + 1);
                }
            }
            
            // 跳转到指定章节
            goToChapter() {
                const chapterNumber = parseInt(this.chapterInput.value);
                if (isNaN(chapterNumber) || chapterNumber < 1 || chapterNumber > this.chapters.length) {
                    alert(`请输入有效的章节号 (1-${this.chapters.length})`);
                    return;
                }
                
                // 章节号从1开始，数组索引从0开始
                this.showChapter(chapterNumber - 1);
            }
            
            // 显示章节列表
            showChapterList() {
                // 清空章节列表
                this.chapterListItems.innerHTML = '';
                
                // 生成章节列表（只显示纯数字编号）
                this.chapters.forEach((chapter, index) => {
                    const chapterItem = document.createElement('div');
                    chapterItem.className = `chapter-list-item ${index === this.currentChapterIndex ? 'active' : ''}`;
                    
                    // 只显示纯数字编号，去掉"第一节"、"第一卷"等冗余信息
                    const pureNumber = index + 1; // 直接使用索引作为章节编号
                    chapterItem.textContent = `第${pureNumber}章`;
                    
                    chapterItem.addEventListener('click', () => {
                        this.showChapter(index);
                        this.hideChapterList();
                    });
                    this.chapterListItems.appendChild(chapterItem);
                });
                
                // 显示模态框
                this.chapterListModal.style.display = 'flex';
            }
            
            // 隐藏章节列表
            hideChapterList() {
                this.chapterListModal.style.display = 'none';
            }
            
            // 更改字体大小
            changeFontSize(size) {
                this.fontSize = size;
                this.contentElement.className = `content ${size}`;
            }
            
            // 切换夜间模式
            toggleNightMode() {
                this.isNightMode = !this.isNightMode;
                document.body.classList.toggle('night-mode', this.isNightMode);
                this.toggleModeBtn.textContent = this.isNightMode ? '日间模式' : '夜间模式';
            }
            
            // 返回小说列表
            showBookSelection() {
                this.readerSection.style.display = 'none';
                this.bookSelection.style.display = 'block';
                this.chapters = [];
                this.currentChapterIndex = 0;
            }
        }
        
        // ############################################################
        // ##### GitHub音乐播放器功能实现 #####
        // ############################################################
        
        class GitHubMusicPlayer {
          constructor() {
            this.audio = document.getElementById('audioPlayer');
            this.playlist = [];
            this.currentTrack = 0;
            this.isPlaying = false;
            this.lyricsData = [];
            
            this.initializeElements();
            this.bindEvents();
            this.scanMusicFolder();
          }
          
          initializeElements() {
            this.miniPlayer = document.getElementById('miniPlayer');
            this.fullPlayer = document.getElementById('fullPlayer');
            this.closeBtnPlayer = document.getElementById('closeBtnPlayer');
            this.albumCover = document.getElementById('albumCover');
            this.songTitle = document.getElementById('songTitle');
            this.songArtist = document.getElementById('songArtist');
            this.lyricsContainer = document.getElementById('lyricsContainer');
            this.lyrics = document.getElementById('lyrics');
            this.lyricsToggle = document.getElementById('lyricsToggle');
            this.progressContainer = document.getElementById('progressContainer');
            this.progressBar = document.getElementById('progressBar');
            this.prevBtn = document.getElementById('prevBtn');
            this.playBtn = document.getElementById('playBtn');
            this.nextBtn = document.getElementById('nextBtn');
            this.fileInputMusic = document.getElementById('fileInputMusic');
            this.playlistContainer = document.getElementById('playlistContainer');
            this.defaultPlaylistItem = document.getElementById('defaultPlaylistItem');
            this.volumeSlider = document.getElementById('volumeSlider');
            this.loadingIndicator = document.getElementById('loadingIndicator');
          }
          
          bindEvents() {
            // 播放器显示/隐藏控制
            this.miniPlayer.addEventListener('click', () => {
              this.fullPlayer.classList.add('active');
            });
            
            this.closeBtnPlayer.addEventListener('click', () => {
              this.fullPlayer.classList.remove('active');
            });
            
            // 播放控制
            this.playBtn.addEventListener('click', () => this.togglePlay());
            this.prevBtn.addEventListener('click', () => this.prevTrack());
            this.nextBtn.addEventListener('click', () => this.nextTrack());
            
            // 歌词显示切换
            this.lyricsToggle.addEventListener('change', () => {
              if (this.lyricsToggle.checked) {
                this.lyricsContainer.classList.add('show');
              } else {
                this.lyricsContainer.classList.remove('show');
              }
            });
            
            // 进度条控制
            this.progressContainer.addEventListener('click', (e) => {
              const percent = e.offsetX / this.progressContainer.offsetWidth;
              this.audio.currentTime = percent * this.audio.duration;
            });
            
            // 文件选择（用于本地测试）
            this.fileInputMusic.addEventListener('change', (e) => {
              this.handleFileSelect(e);
            });
            
            // 音量控制
            this.volumeSlider.addEventListener('input', (e) => {
              this.audio.volume = e.target.value;
            });
            
            // 音频事件
            this.audio.addEventListener('timeupdate', () => this.updateProgress());
            this.audio.addEventListener('timeupdate', () => this.updateLyrics());
            this.audio.addEventListener('ended', () => this.nextTrack());
            this.audio.addEventListener('play', () => this.setPlayingState(true));
            this.audio.addEventListener('pause', () => this.setPlayingState(false));
            this.audio.addEventListener('error', (e) => {
              console.error('音频播放错误:', e);
              this.loadingIndicator.style.display = 'none';
              // 不再显示错误提示，因为可能是跨域问题
            });
            this.audio.addEventListener('loadstart', () => {
              this.loadingIndicator.style.display = 'block';
            });
            this.audio.addEventListener('canplay', () => {
              this.loadingIndicator.style.display = 'none';
            });
          }
          
          // 扫描music文件夹中的音乐文件 - 使用GitHub API
          async scanMusicFolder() {
            try {
                // 获取当前页面的URL信息来确定仓库信息
                const path = window.location.pathname;
                const repoPath = path.split('/')[1]; // 获取仓库名
                const username = window.location.hostname.split('.')[0]; // 获取用户名
                
                // 如果是在本地运行，使用备用方法
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    this.scanMusicFolderFallback();
                    return;
                }
                
                // 使用GitHub API获取music文件夹中的文件
                const apiUrl = `https://api.github.com/repos/${username}/${repoPath}/contents/music`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('无法访问GitHub API');
                }
                
                const files = await response.json();
                const musicFiles = [];
                
                // 筛选出音乐文件
                files.forEach(file => {
                    if (file.name.endsWith('.mp3') || file.name.endsWith('.flac')) {
                        musicFiles.push({
                            name: file.name,
                            url: file.download_url,
                            path: file.path, // 保存文件路径
                            title: file.name.replace(/\.[^/.]+$/, ""),
                            artist: "未知艺术家"
                        });
                    }
                });
                
                // 添加音乐文件到播放列表
                for (const file of musicFiles) {
                    this.playlist.push(file);
                }
                
                // 更新播放列表显示
                this.updatePlaylistDisplay();
                
                // 如果有音乐文件，加载第一首
                if (this.playlist.length > 0) {
                    this.loadTrack(0);
                } else {
                    this.songTitle.textContent = "未找到音乐文件";
                    this.songArtist.textContent = "请在music文件夹中添加音乐";
                }
            } catch (error) {
                console.error('扫描音乐文件夹时出错:', error);
                // 如果API访问失败，尝试备用方法
                this.scanMusicFolderFallback();
            }
          }
          
          // 备用音乐加载方法
          async scanMusicFolderFallback() {
            try {
                // 尝试获取常见的音乐文件
                const commonMusic = [
                    'example1.mp3',
                    'example2.mp3',
                    'music1.mp3',
                    'music2.mp3'
                ];
                
                for (const musicName of commonMusic) {
                    try {
                        const response = await fetch(`music/${musicName}`);
                        if (response.ok) {
                            this.playlist.push({
                                name: musicName,
                                url: `music/${musicName}`,
                                title: musicName.replace(/\.[^/.]+$/, ""),
                                artist: "未知艺术家"
                            });
                        }
                    } catch (err) {
                        // 文件不存在，跳过
                    }
                }
                
                // 更新播放列表显示
                this.updatePlaylistDisplay();
                
                // 如果有音乐文件，加载第一首
                if (this.playlist.length > 0) {
                    this.loadTrack(0);
                } else {
                    this.songTitle.textContent = "未找到音乐文件";
                    this.songArtist.textContent = "请在music文件夹中添加音乐";
                }
            } catch (error) {
                console.error('备用音乐加载方法失败:', error);
                this.songTitle.textContent = "音乐加载失败";
                this.songArtist.textContent = "请检查网络连接";
            }
          }
          
          // 处理本地文件选择（用于测试）
          handleFileSelect(event) {
            const files = Array.from(event.target.files).filter(file => 
              file.type.startsWith('audio/') || 
              file.name.endsWith('.mp3') || 
              file.name.endsWith('.flac')
            );
            
            if (files.length === 0) {
              alert('请选择有效的音频文件（MP3或FLAC格式）');
              return;
            }
            
            files.forEach(file => {
              const url = URL.createObjectURL(file);
              this.playlist.push({
                name: file.name,
                url: url,
                title: file.name.replace(/\.[^/.]+$/, ""),
                artist: "本地音乐"
              });
            });
            
            // 更新播放列表显示
            this.updatePlaylistDisplay();
            
            // 如果是第一次添加音乐，则自动播放第一首
            if (this.playlist.length > 0 && !this.isPlaying) {
              this.loadTrack(0);
            }
          }
          
          // 加载指定音乐
          async loadTrack(index) {
            if (this.playlist.length === 0) return;
            
            this.currentTrack = index;
            const track = this.playlist[index];
            
            // 对于GitHub托管的文件，我们直接使用相对路径而不是download_url
            if (track.path) {
                // 使用相对路径而不是download_url
                this.audio.src = track.path;
            } else {
                this.audio.src = track.url;
            }
            
            this.songTitle.textContent = track.title;
            this.songArtist.textContent = track.artist;
            
            // 尝试加载封面图片
            await this.loadCoverImage(track);
            
            // 尝试加载歌词文件（同名.lrc文件）
            await this.loadLyrics(track);
            
            // 更新播放列表高亮
            this.updatePlaylistDisplay();
            
            if (this.isPlaying) {
              // 等待音频加载完成后播放
              this.audio.load();
              // 不再捕获播放错误，因为可能是跨域问题
              this.audio.play();
            }
          }
          
          // 加载封面图片
          async loadCoverImage(track) {
            try {
              // 构造封面文件名（将音乐文件扩展名替换为.jpg）
              const coverFileName = track.name.replace(/\.[^/.]+$/, ".jpg");
              
              // 如果有path信息，使用path构造封面URL
              if (track.path) {
                const coverPath = track.path.replace(/\.[^/.]+$/, ".jpg");
                const coverResponse = await fetch(coverPath);
                if (coverResponse.ok) {
                  this.albumCover.src = coverPath;
                  return;
                }
              }
              
              // 尝试直接访问
              const directUrl = `music/${coverFileName}`;
              const directResponse = await fetch(directUrl);
              if (directResponse.ok) {
                this.albumCover.src = directUrl;
                return;
              }
              
              // 如果都失败了，使用默认封面
              this.albumCover.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiMzMzMzMzMiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzIyMjIyMiIvPjxwYXRoIGQ9Ik01MCwxMEw2MCw0MEw5MCw0MEw2NSw2MEw3NSw5MEw1MCw3MEwyNSw5MEwzNSw2MEwxMCw0MEw0MCw0MEw1MCwxMFoiIGZpbGw9IiNmZjAwMDAiLz48L3N2Zz4=";
            } catch (error) {
              console.log('封面加载失败:', error);
              // 使用默认封面
              this.albumCover.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiMzMzMzMzMiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzIyMjIyMiIvPjxwYXRoIGQ9Ik01MCwxMEw2MCw0MEw5MCw0MEw2NSw2MEw3NSw5MEw1MCw3MEwyNSw5MEwzNSw2MEwxMCw0MEw0MCw0MEw1MCwxMFoiIGZpbGw9IiNmZjAwMDAiLz48L3N2Zz4=";
            }
          }
          
          // 加载歌词文件
          async loadLyrics(track) {
            try {
              // 构造歌词文件名（将音乐文件扩展名替换为.lrc）
              const lyricsFileName = track.name.replace(/\.[^/.]+$/, ".lrc");
              
              // 如果有path信息，使用path构造歌词URL
              if (track.path) {
                const lyricsPath = track.path.replace(/\.[^/.]+$/, ".lrc");
                const lyricsResponse = await fetch(lyricsPath);
                if (lyricsResponse.ok) {
                  const lyricsText = await lyricsResponse.text();
                  this.parseLyrics(lyricsText);
                  return;
                }
              }
              
              // 尝试直接访问
              const directUrl = `music/${lyricsFileName}`;
              const directResponse = await fetch(directUrl);
              if (directResponse.ok) {
                const lyricsText = await directResponse.text();
                this.parseLyrics(lyricsText);
                return;
              }
              
              // 如果都失败了
              this.lyricsData = [];
              this.lyrics.textContent = "暂无歌词";
            } catch (error) {
              console.log('歌词加载失败:', error);
              this.lyricsData = [];
              this.lyrics.textContent = "暂无歌词";
            }
          }
          
          // 解析LRC歌词格式
          parseLyrics(lyricsText) {
            this.lyricsData = [];
            const lines = lyricsText.split('\n');
            
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;
            
            lines.forEach(line => {
              const match = line.match(timeRegex);
              if (match) {
                const minutes = parseInt(match[1]);
                const seconds = parseInt(match[2]);
                const milliseconds = match[3].length === 2 ? parseInt(match[3]) * 10 : parseInt(match[3]);
                const time = minutes * 60 + seconds + milliseconds / 1000;
                const text = match[4].trim();
                
                if (text) {
                  this.lyricsData.push({ time, text });
                }
              }
            });
            
            // 按时间排序
            this.lyricsData.sort((a, b) => a.time - b.time);
          }
          
          // 更新当前歌词显示
          updateLyrics() {
            if (!this.lyricsData.length || !this.lyricsToggle.checked) return;
            
            const currentTime = this.audio.currentTime;
            let currentLyric = "享受音乐时光";
            
            // 找到当前时间对应的歌词
            for (let i = 0; i < this.lyricsData.length; i++) {
              if (currentTime >= this.lyricsData[i].time) {
                if (i === this.lyricsData.length - 1 || currentTime < this.lyricsData[i + 1].time) {
                  currentLyric = this.lyricsData[i].text;
                  break;
                }
              }
            }
            
            this.lyrics.textContent = currentLyric;
          }
          
          // 播放/暂停控制
          togglePlay() {
            if (this.playlist.length === 0) {
              alert('请先添加音乐文件');
              return;
            }
            
            if (this.isPlaying) {
              this.audio.pause();
            } else {
              if (!this.audio.src) {
                this.loadTrack(this.currentTrack);
              }
              this.audio.play();
            }
          }
          
          // 设置播放状态
          setPlayingState(playing) {
            this.isPlaying = playing;
            this.playBtn.textContent = playing ? '❚❚' : '▶';
            
            if (playing) {
              this.fullPlayer.classList.add('playing');
            } else {
              this.fullPlayer.classList.remove('playing');
            }
          }
          
          // 上一首
          prevTrack() {
            if (this.playlist.length === 0) return;
            
            this.currentTrack = (this.currentTrack - 1 + this.playlist.length) % this.playlist.length;
            this.loadTrack(this.currentTrack);
            
            if (this.isPlaying) {
              this.audio.play();
            }
          }
          
          // 下一首
          nextTrack() {
            if (this.playlist.length === 0) return;
            
            this.currentTrack = (this.currentTrack + 1) % this.playlist.length;
            this.loadTrack(this.currentTrack);
            
            if (this.isPlaying) {
              this.audio.play();
            }
          }
          
          // 更新进度条
          updateProgress() {
            if (this.audio.duration) {
              const percent = (this.audio.currentTime / this.audio.duration) * 100;
              this.progressBar.style.width = `${percent}%`;
            }
          }
          
          // 更新播放列表显示
          updatePlaylistDisplay() {
            // 清空播放列表
            this.playlistContainer.innerHTML = '';
            
            if (this.playlist.length === 0) {
              this.playlistContainer.innerHTML = '<div class="playlist-item" id="defaultPlaylistItem">暂无播放列表</div>';
              return;
            }
            
            // 添加播放列表项
            this.playlist.forEach((track, index) => {
              const playlistItem = document.createElement('div');
              playlistItem.className = `playlist-item ${index === this.currentTrack ? 'active' : ''}`;
              playlistItem.textContent = track.title;
              
              playlistItem.addEventListener('click', () => {
                this.loadTrack(index);
                if (!this.isPlaying) {
                  this.audio.play();
                }
              });
              
              this.playlistContainer.appendChild(playlistItem);
            });
          }
        }
        
        // 初始化阅读器和音乐播放器
        document.addEventListener('DOMContentLoaded', () => {
            new ModernNovelReader();
            new GitHubMusicPlayer();
        });
    </script>
</body>
</html>
